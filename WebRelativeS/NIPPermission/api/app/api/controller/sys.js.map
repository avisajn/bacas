{"version":3,"sources":["../../../src/api/controller/sys.js"],"names":["UID","require","DateFormat","db","dbpermission","getAction","id","model","model_info","field","select","syslist","infolist","infoObj","_id","newList","map","k","sysid","type","push","label","key","name","desc","success","sys","info","params","get","current","rowCount","where","page","list","count","postAction","param","post","time","Date","fail","model_sys","add","testurl","url","status","putAction","update","insertId","deleteAction"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA;;;;AACA;;;;;;AAHA,IAAIA,MAAMC,QAAQ,WAAR,CAAV;AACA,IAAIC,aAAaD,QAAQ,YAAR,CAAjB;;AAGA,IAAME,KAAK,aAAGC,YAAd;;;;;;;;;;qBAGUC,S;;;;;;;;;;kCAEC,KAAKC,EAAL,IAAW,KAAKA,EAAL,IAAW,K;;;;;;;;;;;;AACrB;AACIC,qD,GAAQ,OAAKA,KAAL,CAAW,KAAX,EAAiBJ,EAAjB,C;AACRK,0D,GAAa,OAAKD,KAAL,CAAW,SAAX,EAAqBJ,EAArB,C;;uDACGI,MAAME,KAAN,CAAY,SAAZ,EAAuBC,MAAvB,E;;;AAAhBC,uD;;uDACiBH,WAAWE,MAAX,E;;;AAAjBE,wD;AACAC,uD,GAAU,E;AACVC,mD,GAAM,I;AACNC,uD,GAAU,E;;AACdH,yDAASI,GAAT,CAAa,UAACC,CAAD,EAAO;AAChBH,0DAAMG,EAAEC,KAAR;AACA,wDAAG,CAACL,QAAQC,GAAR,CAAJ,EAAiB;AACdD,gEAAQC,GAAR,IAAe,EAAf;AACF;AACD,wDAAGG,EAAEE,IAAF,IAAU,CAAb,EAAe;AACXF,0DAAEE,IAAF,GAAS,IAAT;AACH,qDAFD,MAEK;AACDF,0DAAEE,IAAF,GAAS,IAAT;AACH;AACDN,4DAAQC,GAAR,EAAaM,IAAb,CAAkB;AACdC,+DAAQJ,EAAEE,IADI;AAEdG,6DAAML,EAAEX,EAAF,GAAK,EAFG;AAGdiB,8DAAON,EAAEK,GAHK;AAIdE,8DAAOP,EAAEO;AAJK,qDAAlB;AAMH,iDAhBD;;uDAiBO,OAAKC,OAAL,CAAa,EAACC,KAAMf,OAAP,EAAgBgB,MAAOd,OAAvB,EAAb;;;;;;;;;;;;;;;;;;;;;;;;;;AAKHe,kC,GAAc,KAAKC,GAAL,MAAc,E,EAC5BP,G,GAAcM,OAAON,G,EACrBQ,O,GAAcF,OAAOE,OAAP,IAAkB,C,EAChCC,Q,GAAcH,OAAOG,QAAP,IAAmB,E;AAEjCC,iC,GAAQ,E;AACZ;;AACA,gCAAIV,GAAJ,EAAS;AAAEU,sCAAM,MAAN,IAAgB,CAAC,MAAD,EAAS,MAAMV,GAAN,GAAY,GAArB,CAAhB;AAA4C;;AAEnDf,kC,GAAQ,KAAKA,KAAL,CAAW,KAAX,EAAiBJ,EAAjB,C;;mCACKI,OAAME,KAAN,CAAY,qBAAZ,EAAmCwB,IAAnC,CAAwCH,OAAxC,EAAiDC,QAAjD,EAA2DC,KAA3D,CAAiEA,KAAjE,EAAwEtB,MAAxE,E;;;AAAbwB,gC;;mCAEc3B,OAAMyB,KAAN,CAAYA,KAAZ,EAAmBG,KAAnB,CAAyB,IAAzB,C;;;AAAdA,iC;8DAEG,KAAKV,OAAL,CAAa;AAClB,2CAAWK,OADO;AAElB,4CAAYC,QAFM;AAGlB,wCAAQG,IAHU;AAIlB,yCAASC;AAJS,6BAAb,C;;;;;;;;;;;;;;;;;AASf;;;qBACMC,U;;;;;;;AACEC,iC,GAAQ,KAAKC,IAAL,E;AACRf,gC,GAAOc,MAAMd,I,EACbgB,I,GAAOrC,WAAW,IAAIsC,IAAJ,EAAX,EAAuB,qBAAvB,C;;gCAEPjB,I;;;;;8DACO,KAAKkB,IAAL,CAAU,CAAC,CAAX,EAAc,OAAd,C;;;AAEPC,qC,GAAY,KAAKnC,KAAL,CAAW,KAAX,EAAiBJ,EAAjB,C;;mCACVuC,UAAUC,GAAV,CAAc;AAChBpB,sCAAOA,IADS;AAEhBqB,yCAAUP,MAAMO,OAAN,IAAiB,EAFX;AAGhBC,qCAAMR,MAAMQ,GAAN,IAAa,EAHH;AAIhBC,wCAAS;AAJO,6BAAd,C;;;8DAMC,KAAKrB,OAAL,CAAa,OAAb,C;;;;;;;;;;;;;;;;;AAGX;;;qBACMsB,S;;;;;;;gCACE,KAAKzC,E;;;;;8DACE,KAAKmC,IAAL,CAAU,OAAV,C;;;AAGPJ,iC,GAAQ,KAAKC,IAAL,E;AACRhC,8B,GAAK+B,MAAM/B,E,EAAIiB,I,GAAOc,MAAMd,I;;gCAC5BA,I;;;;;8DACO,KAAKkB,IAAL,CAAU,CAAC,CAAX,EAAc,OAAd,C;;;AAEPC,qC,GAAY,KAAKnC,KAAL,CAAW,KAAX,EAAiBJ,EAAjB,C;;mCAEKuC,UAAUV,KAAV,CAAgB,EAAC1B,IAAIA,EAAL,EAAhB,EAA2B0C,MAA3B,CAAkC;AACnDzB,sCAAOA,IAD4C;AAEnDqB,yCAAUP,MAAMO,OAAN,IAAiB,EAFwB;AAGnDC,qCAAMR,MAAMQ,GAAN,IAAa;AAHgC,6BAAlC,C;;;AAAjBI,oC;8DAKG,KAAKxB,OAAL,CAAa,MAAb,C;;;;;;;;;;;;;;;;;qBAGLyB,Y;;;;;;8DAmBK,KAAKzB,OAAL,CAAa,OAAb,C","file":"sys.js","sourcesContent":["'use strict';\nlet UID = require('node-uuid');\nlet DateFormat = require('dateformat');\nimport Base from './baserest.js';\nimport DB from '../../db.js';\nconst db = DB.dbpermission;\n\nexport default class extends Base {\n    async getAction(){\n        //获取信息\n        if(this.id && this.id == 'all'){\n            // 获取所有系统，及系统的所有权限\n            let model = this.model('sys',db);\n            let model_info = this.model('sysinfo',db);\n            let syslist = await model.field('id,name').select();\n            let infolist = await model_info.select();\n            let infoObj = {};\n            let _id = null;\n            let newList = [];\n            infolist.map((k) => {\n                _id = k.sysid;\n                if(!infoObj[_id]){\n                   infoObj[_id] = []; \n                }\n                if(k.type == 1){\n                    k.type = '页面';\n                }else{\n                    k.type = '功能';\n                }\n                infoObj[_id].push({\n                    label : k.type ,\n                    key : k.id+\"\",\n                    name : k.key,\n                    desc : k.desc\n                });\n            });\n            return this.success({sys : syslist, info : infoObj });\n        }\n        // 获取列表\n        else{\n\n            let params      = this.get() || {},\n                key         = params.key,\n                current     = params.current || 1,\n                rowCount    = params.rowCount || 30;\n\n            let where = {}\n            // let where = {'adduser': this.getUserId() }\n            if (key) { where['name'] = ['like', '%' + key + '%']; }\n\n            let model = this.model('sys',db);\n            let list = await model.field('id,name,testurl,url').page(current, rowCount).where(where).select();\n\n            let count = await model.where(where).count('id');\n\n            return this.success({\n              \"current\": current,\n              \"rowCount\": rowCount,\n              \"rows\": list,\n              \"total\": count\n            });\n        }\n    }\n\n    // 添加一条数据\n    async postAction(){\n        let param = this.post();\n        let name = param.name,\n            time = DateFormat(new Date(), \"yyyy-mm-dd hh:MM:ss\");\n\n        if(!name){\n            return this.fail(-1 ,'参数不正确');\n        }\n        let model_sys = this.model('sys',db);\n        await model_sys.add({\n            name : name,\n            testurl : param.testurl || '',\n            url : param.url || '',\n            status : 0,\n        })\n        return this.success('添加成功！');\n    }\n\n    // 修改一条数据\n    async putAction(){\n        if(!this.id){\n            return this.fail('id为空！');\n        }\n\n        let param = this.post();\n        let id = param.id, name = param.name;\n        if(!name){\n            return this.fail(-1 ,'参数不正确');\n        }\n        let model_sys = this.model('sys',db);\n\n        let insertId = await model_sys.where({id: id }).update({\n            name : name,\n            testurl : param.testurl || '',\n            url : param.url || '',\n        });\n        return this.success('修改成功');\n    }\n\n    async deleteAction(){\n        // let uid = this.id;\n        // if (!uid) return this.fail('id为空！');\n        // // 需要删除 课程表、课程目录表、课程内容表、课程结构表、课程分享表、试题表、纠错表\n        // let model_course = this.model('course',db),\n        //     model_coursecatalog = this.model('coursecatalog',db),\n        //     model_coursecontent = this.model('coursecontent',db),\n        //     model_coursemind = this.model('coursemind',db),\n        //     model_courseshare = this.model('courseshare',db),\n        //     model_question = this.model('question',db),\n        //     model_buglog = this.model('buglog',db);\n\n        // model_course.delete({where: {uid: uid } });\n        // model_coursemind.delete({where: {cuid: uid } });\n        // model_coursecatalog.delete({where: {cuid: uid } });\n        // model_coursecontent.delete({where: {cuid: uid } });\n        // model_courseshare.delete({where: {cuid: uid } });\n        // model_question.delete({where: {cuid: uid } });\n        // model_buglog.delete({where: {cuid: uid } });\n        return this.success('删除成功！');\n    }\n}"]}