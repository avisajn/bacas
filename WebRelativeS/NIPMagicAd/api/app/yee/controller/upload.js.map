{"version":3,"sources":["../../../src/yee/controller/upload.js"],"names":["co","require","OSS","region","client","renameFile","tmp_path","target_path","r","f","fs","rename","err","unlink","removeFile","path","uploadImage","name","buffer_data","useBucket","put","result","url","catch","console","log","imgAction","allow","fail","http","method","toLocaleLowerCase","post","mbName","base64Code","k","type","t","indexOf","replace","Buffer","link_name","success"],"mappings":"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","file":"upload.js","sourcesContent":["'use strict';\nimport Base from './base.js';\nimport {encryptCode ,decryptCode } from '../../util.js';\nimport ALIConfig from '../../ali.js';\nimport moment from 'moment';\n\nconst co = require('co');\nconst OSS = require('ali-oss');\nALIConfig.region = 'oss-cn-shanghai';\nconst client = new OSS(ALIConfig);\n\n\n\nconst renameFile = function(tmp_path ,target_path){\n    return new Promise((r ,f) => {\n        // // 移动文件\n        fs.rename(tmp_path, target_path, function(err) {\n            if (err) throw err;\n            // 删除临时文件夹文件, \n            fs.unlink(tmp_path, function() {\n                if (err) throw err;  \n                r();\n            });\n        });\n    })\n},\n\nremoveFile = function(path){\n    return new Promise((r ,f) => {\n        fs.unlink(path, function(err) {\n            if (err) throw err;  \n            r();\n        });\n    })\n},\n\nuploadImage = function(path ,name, buffer_data){\n    return new Promise((r ,f) => {\n        co(function* () {\n          client.useBucket('ymark-public');\n          var result = yield client.put(path+name, buffer_data);\n          r(result.url);\n        }).catch(function (err) {\n            console.log('err:',err);\n            r();\n        });\n    })\n\n};\n\nexport default class extends Base {\n    async imgAction(){\n        if(!this.allow) {return this.fail(-1 ,'not allow');  }\n        if(this.http.method.toLocaleLowerCase() != 'post') {return this.fail(-0.5 ,'参数错误') ; }\n        let {name:mbName ,k:base64Code ,t:type } = this.post() || {};\n        // 判断参数\n        if(!mbName || !type || !base64Code || base64Code.indexOf(';base64,') < 0) {return this.fail(-1 ,'参数错误') ; }\n        let path = '';\n        if(type == 'yeelogo'){\n            path = 'yeelogo/template/';\n        }else if(type == 'yworlde'){\n            path = 'cloud/pay/';\n        }\n        base64Code = base64Code.replace(/^data:image\\/\\w+;base64,/, \"\");\n        // 得到文件\n        let link_name = await uploadImage(path,mbName+'.png' ,new Buffer(base64Code, 'base64'));\n        if(!link_name) return this.fail(-1 ,'上传错误！'); \n        // return this.success(link_name.replace('ymark-public.oss-cn-shanghai.aliyuncs.com','oss.ymark.cc'));\n        return this.success(path+mbName+'.png');\n    }\n\n\n}   "]}