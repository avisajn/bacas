{"version":3,"sources":["../../../src/api/controller/user.js"],"names":["UID","require","DateFormat","getAction","id","userid","rids","get","model","field","alias","join","where","select","list","success","params","key","current","rowCount","page","length","roleids","map","k","push","model_role","_allroles","allroles","name","_ids","_names","indexOf","split","i","rolesname","count","postAction","param","post","username","password","roles","country","time","Date","fail","add","addtime","status","putAction","update","insertId","deleteAction","uid","delete"],"mappings":"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","file":"user.js","sourcesContent":["'use strict';\nlet UID = require('node-uuid');\nlet DateFormat = require('dateformat');\nimport Base from './baserest.js';\n\nexport default class extends Base {\n    async getAction(){\n        //获取信息\n        if(this.id){\n            let userid = this.id;\n            let rids = this.get().rids;\n            let model = this.model('rolesys');\n            let list = await model.field('s.`name` sysname ,s.testurl ,s.url,s.id sysid,si.`key` ,si.type,si.`desc`').alias('base')\n                             .join([ 'sys s on s.id=base.sysid','sysinfo si on si.id=base.sysinfoid'])\n                             .where('roleid in ('+rids+')').select();\n            return this.success(list);\n        }\n        // 获取列表\n        else{\n\n            let params      = this.get() || {},\n                key         = params.key,\n                current     = params.current || 1,\n                rowCount    = params.rowCount || 10;\n\n            let where = {}\n            // let where = {'adduser': this.getUserId() }\n            if (key) { where['username'] = ['like', '%' + key + '%']; }\n\n            let model = this.model('user');\n            let list = await model.field('id,country,username,roleids,addtime').alias('base').page(current, rowCount).where(where).select();\n            if(list.length > 0){\n                let roleids = [];\n                list.map((k) => {\n                    roleids.push(k.roleids);\n                });\n                let model_role = this.model('role');\n                let _allroles = await model_role.field('id ,name').where(\"id in (\"+roleids+\")\").select();\n                let allroles = {};\n                _allroles.map((k) => {allroles[k.id] = k.name; });\n                let _ids = null;\n                let _names = null;\n                list.map((k) => {\n                    _ids = k.roleids+\"\";\n                    if(_ids.indexOf(',') > 0){\n                        _ids = _ids.split(',');\n                        k.roleids = _ids;\n                        _names = [];\n                        for(let i=0;i<_ids.length;i++){\n                            _names.push(allroles[_ids[i]]);\n                        }\n                        k.rolesname = _names;\n                    }else{\n                        k.rolesname = [allroles[_ids]];\n                        k.roleids = [_ids];\n                    }\n                });\n            }\n\n            let count = await model.where(where).count('id');\n            return this.success({\n              \"current\": current,\n              \"rowCount\": rowCount,\n              \"rows\": list,\n              \"total\": count\n            });\n        }\n    }\n\n    // 添加一条数据\n    async postAction(){\n        let param = this.post();\n        let username = param.username,\n            password = param.password,\n            roleids = param.roles,\n            country = param.country,\n            time = DateFormat(new Date(), \"yyyy-mm-dd hh:MM:ss\");\n\n        if(!username || !password || !roleids){\n            return this.fail(-1 ,'参数不正确');\n        }\n\n        let model = this.model('user');\n        await model.add({\n            username : username,\n            password : password,\n            roleids : roleids,\n            country : country,\n            addtime : time,\n            status : 0,\n        })\n        return this.success('添加成功！');\n    }\n\n    // 修改一条数据\n    async putAction(){\n        if(!this.id){\n            return this.fail('id为空！');\n        }\n\n        let param = this.post();\n        let id = param.id, \n            username = param.username,\n            country = param.country,\n            roleids = param.roles;\n        if(!username || !roleids){\n            return this.fail(-1 ,'参数不正确');\n        }\n        let model = this.model('user');\n\n        let insertId = await model.where({id: id }).update({\n            username : username,\n            roleids : roleids,\n            country : country\n        });\n        return this.success('修改成功');\n    }\n\n    async deleteAction(){\n        let uid = this.id;\n        if (!uid) return this.fail('id为空！');\n        let model = this.model('user');\n        await model.delete({where: {id: uid } });\n        return this.success('删除成功！');\n    }\n}"]}