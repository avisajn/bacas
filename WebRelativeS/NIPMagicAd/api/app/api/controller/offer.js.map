{
    "version": 3,
    "sources": [
        "../../../src/api/controller/offer.js"
    ],
    "names": [
        "container",
        "cdnHost",
        "id",
        "br",
        "db",
        "dbmagicad",
        "blobService",
        "createBlobService",
        "renameFile",
        "tmp_path",
        "target_path",
        "r",
        "f",
        "rename",
        "err",
        "unlink",
        "uploadImage",
        "name",
        "country",
        "file_path",
        "think",
        "RUNTIME_PATH",
        "createBlockBlobFromLocalFile",
        "error",
        "result",
        "response",
        "isSuccessful",
        "url",
        "getadunitAction",
        "model",
        "field",
        "where",
        "app",
        "select",
        "data",
        "success",
        "getpublisherAction",
        "savepublisherAction",
        "param",
        "post",
        "fail",
        "add",
        "publisher_name",
        "saveofferAction",
        "start_time",
        "end_time",
        "adunit_id",
        "adunit",
        "publisher_id",
        "publisher",
        "width",
        "height",
        "cta",
        "cta_text",
        "impression_cap",
        "target_url",
        "click_callback_url",
        "impression_callback_url",
        "title",
        "description",
        "creative_url",
        "dateNow",
        "Date",
        "format",
        "model_offer",
        "model_creative",
        "statu",
        "updated_time",
        "offer_id",
        "traget_url",
        "creative_id",
        "uploadimageAction",
        "http",
        "method",
        "start",
        "end",
        "file",
        "_file",
        "path",
        "oldName",
        "originalFilename",
        "ext",
        "substring",
        "lastIndexOf"
    ],
    "mappings": "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",
    "file": "../../../src/api/controller/offer.js",
    "sourcesContent": [
        "'use strict';\nimport azure from 'azure-storage';\nimport moment from 'moment';\nimport Base from './base.js';\nimport DB from '../../db.js';\nimport fs from 'fs';\n\n\nconst container = 'news-images';\nconst cdnHost = {\n    id : 'http://img.cdn.baca.co.id/',\n    br : 'http://img.cdn.baca.co.id/'\n}\n\n\nconst db = DB.dbmagicad;\n\nconst blobService = azure.createBlobService('baca', 'AlfJeE0T/a0hWMXRTR0oYj7GVxhvNAkL+brSotrJqzWmsabcEGJBL57fvMFTe01tHidrvBGWihYmAE6o16ORBA==');\n\nconst renameFile = function(tmp_path ,target_path){\n    return new Promise((r ,f) => {\n        // // 移动文件\n        fs.rename(tmp_path, target_path, function(err) {\n            if (err) throw err;\n            // 删除临时文件夹文件, \n            fs.unlink(tmp_path, function() {\n                if (err) throw err;  \n                r();\n            });\n        });\n    })\n},\n\nuploadImage = function(name ,country){\n    let file_path = think.RUNTIME_PATH + '/upload/' + name;\n    return new Promise((r ,f) => {\n        blobService.createBlockBlobFromLocalFile(container, 'ads/'+name, file_path , function(error, result, response) {\n            if (error || !response.isSuccessful) {r({error}); return; }\n            r({error ,url:cdnHost[country] + 'ads/'+name});\n        });\n    })\n\n}\n\n\nexport default class extends Base {\n    // 返回处理后的列表\n    async getadunitAction(){\n        const model = this.model('adunit' ,db);\n        const data = await model.field('id,name,creative_ratio,creative_size_limitation').where({app:'baca'}).select();\n        // data.map((k) => {\n        //     k.name = k.name+'_'+(parseInt(k.index)+1);\n        //     delete k.index;\n        // })\n        return this.success(data);\n    }\n\n    // 返回所有的发布人\n    async getpublisherAction(){\n        const model = this.model('publisher' ,db);\n        const data = await model.field('id,publisher_name name').select();\n        return this.success(data);\n    }\n\n    // 返回所有的发布人\n    async savepublisherAction(){\n        let param = this.post();\n        let name = param.name;\n        if(!name){\n            return this.fail(-1 ,'参数不正确');\n        }\n        let model = this.model('publisher' ,db);\n        const id = await model.add({publisher_name : name})\n        if(id){\n            return this.success(id);\n        }else{\n            return this.fail(-1 ,id);\n        }\n    }\n\n\n    async saveofferAction(){\n        let param = this.post();\n        let name = param.name,                      // offer 表\n            start_time  = param.start_time,         // offer 表\n            end_time    = param.end_time,           // offer 表\n            adunit_id   = param.adunit,           // offer 表\n            publisher_id    = param.publisher,           // offer 表\n\n            width       = param.width,              // creative 表\n            height      = param.height,\n            cta         = param.cta_text,\n            impression_cap      = param.impression_cap,\n            target_url  = param.target_url,\n            click_callback_url  = param.click_callback_url,\n            impression_callback_url     = param.impression_callback_url,\n            title       = param.title,\n            description     = param.description,\n            creative_url    = param.creative_url,\n\n            country     = 'id', // 默认的国家为印尼\n\n            dateNow = moment(new Date()).format('YYYY-MM-DD HH:mm:ss');\n\n        if(!name){\n            return this.fail(-1 ,'参数不正确');\n        }\n\n        let model_offer = this.model('offer' ,db);\n        let model_creative = this.model('creative' ,db);\n        const offer_id = await model_offer.add({\n            statu : 1,\n            updated_time : dateNow,\n            start_time : start_time,\n            end_time : end_time,\n            publisher_id : publisher_id,\n            impression_cap : impression_cap,\n            adunit_id : adunit_id,\n            name : name,\n        });\n\n        if(!offer_id){\n            return this.fail(-1 ,'插入offer出错！');\n        }\n\n        const creative_id = await model_creative.add({\n            offer_id : offer_id,\n            width : width,\n            height : height,\n            cta : cta,\n            creative_url : creative_url,\n            traget_url : target_url,\n            click_callback_url : click_callback_url,\n            impression_callback_url :impression_callback_url ,\n            title : title,\n            description : description,\n        });\n        if(!creative_id){\n            return this.fail(-1 ,'插入creative出错！');\n        }\n        return this.success({offer_id ,creative_id});\n    }\n\n\n    async uploadimageAction(){\n        // 参考 https://github.com/Azure/azure-storage-node\n        if(this.http.method!='POST'){\n            return this.fail(-1);\n        }\n\n        let param = this.post(),\n            start = param.start ,\n            end = param.end,\n            title = param.title;\n\n        let file = this.http._file[0];\n\n        if(!file || !start || !end || !title){\n            return this.fail(-1 ,'参数错误！');\n        }\n\n        let tmp_path = file.path,\n            oldName = file.originalFilename,\n            ext  = oldName.substring(oldName.lastIndexOf('.'));\n\n        let name = title+\"_\"+start+\"_\"+end+ext;\n\n        let target_path = think.RUNTIME_PATH + '/upload/' + name;\n\n        await renameFile(tmp_path ,target_path);\n\n\n        const {error ,url} = await uploadImage(name ,'id');\n        if(error){\n            return this.fail(-1 ,'上传错误！'+JSON.stringify(error));\n        }\n        return this.success(url);\n    }\n\n\n\n}   "
    ]
}