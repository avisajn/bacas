{"version":3,"sources":["../../../src/activity/controller/img.js"],"names":["co","require","OSS","region","exec","client","renameFile","tmp_path","target_path","r","f","rename","err","unlink","removeFile","path","uploadImage","file_path","real_name","useBucket","put","result","url","catch","pdf2Img","name","callback","stdout","stderr","console","log","data","JSON","parse","uploadAction","allow","fail","http","method","toLocaleLowerCase","params","post","mbname","param","files","_file","file","oldName","Date","getTime","parseInt","Math","random","type","headers","ext","success"],"mappings":"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","file":"img.js","sourcesContent":["'use strict';\nimport moment from 'moment';\nimport Base from './basemy.js';\nimport ALIConfig from '../../ali.js';\n\nimport fs from 'fs';\n\nconst co = require('co');\nconst OSS = require('ali-oss');\nALIConfig.region = 'oss-cn-shanghai';\nconst exec = require('child_process').exec; \nconst client = new OSS(ALIConfig);\n\nconst renameFile = function(tmp_path ,target_path){\n    return new Promise((r ,f) => {\n        // // 移动文件\n        fs.rename(tmp_path, target_path, function(err) {\n            if (err) throw err;\n            // 删除临时文件夹文件, \n            fs.unlink(tmp_path, function() {\n                if (err) throw err;  \n                r();\n            });\n        });\n    })\n},\n\nremoveFile = function(path){\n    return new Promise((r ,f) => {\n        fs.unlink(path, function(err) {\n            if (err) throw err;  \n            r();\n        });\n    })\n},\n\nuploadImage = function(file_path ,real_name){\n    return new Promise((r ,f) => {\n        co(function* () {\n          client.useBucket('ymark-public');\n          var result = yield client.put('yixiaotu/tmp/'+real_name, file_path);\n          r(result.url);\n        }).catch(function (err) {\n          r();\n        });\n    })\n},\n// 压缩图片\n\n\n\n// 将pdf转换成图片\npdf2Img = function(name ,callback){\n    return new Promise((r ,f) => {\n        exec('/home/work/mupdf/mupdf-0.9-linux-amd64/pdfdraw -o out%d.png 12.pdf', function(err,stdout,stderr){\n            if(err) {\n                console.log('get weather api error:'+stderr);\n            } else {\n                /*\n                这个stdout的内容就是上面我curl出来的这个东西：\n                {\"weatherinfo\":{\"city\":\"北京\",\"cityid\":\"101010100\",\"temp\":\"3\",\"WD\":\"西北风\",\"WS\":\"3级\",\"SD\":\"23%\",\"WSE\":\"3\",\"time\":\"21:20\",\"isRadar\":\"1\",\"Radar\":\"JC_RADAR_AZ9010_JB\",\"njd\":\"暂无实况\",\"qy\":\"1019\"}}\n                */\n                var data = JSON.parse(stdout);\n                console.log(data);\n            }\n        });\n        co(function* () {\n          client.useBucket('ymark-public');\n          var result = yield client.put('yixiaotu/tmp/'+real_name, file_path);\n          r(result.url);\n        }).catch(function (err) {\n          r();\n        });\n    })\n}\n\n\n\n\nexport default class extends Base {\n\n    async uploadAction(){\n        if(!this.allow) {return this.fail(-1 ,'not allow');  }\n        if(this.http.method.toLocaleLowerCase() != 'post') {return this.fail(-1 ,'参数错误') ; }\n        let params      = this.post() || {},\n            mbname      = params.name;\n\n        if(!mbname) return this.fail(-1 ,'参数错误');\n\n        let param = this.post();\n        let files = this.http._file;\n        let file = files[0];\n\n        let tmp_path = file.path,\n            oldName = new Date().getTime()+\"\"+parseInt(Math.random()*1000),\n            type = file.headers['content-type'],\n            ext  = '.png';\n\n        let name = oldName+ext;\n\n        return this.success(-1);\n\n        // let link_name = await uploadImage(tmp_path ,name);\n        // if(!link_name) return this.fail(-1 ,'上传错误！');\n        // link_name = link_name.replace('ymark-public.oss-cn-shanghai.aliyuncs.com' ,'oss.ymark.cc');\n        // return this.success(link_name);\n        \n    }\n\n\n}   "]}