{"version":3,"sources":["../../../src/activity/controller/iftar.js"],"names":["db","activity","container","cdnHost","id","br","blobService","createBlobService","renameFile","tmp_path","target_path","r","f","rename","err","unlink","removeFile","path","uploadImage","name","country","file_path","think","RUNTIME_PATH","createBlockBlobFromLocalFile","error","result","response","isSuccessful","console","log","url","uploadimageAction","fail","param","post","files","http","_file","len","k","RESOURCE_PATH","names","file","oldName","originalFilename","ext","substring","lastIndexOf","newName","Date","getTime","parseInt","Math","random","push","success","uploadAction","uploadazureAction","setlikeAction","model","paramObj","user_id","_from","iftar_id","_to","where","count","_type","model_iftar","add","execute","delete","getlistAction","res","map","islike","field","limit","order","select","getbyidAction","userid","length"],"mappings":"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","file":"iftar.js","sourcesContent":["'use strict';\nimport azure from 'azure-storage';\nimport moment from 'moment';\nimport Base from './base.js';\nimport DB from '../../db.js';\nimport fs from 'fs';\n\nconst db = DB.activity;\n\nconst container = 'activity-images';\nconst cdnHost = {\n    id : 'http://baca-activity.azureedge.net/',\n    br : 'http://baca-activity.azureedge.net/'\n}\n\n\nconst blobService = azure.createBlobService('baca', 'AlfJeE0T/a0hWMXRTR0oYj7GVxhvNAkL+brSotrJqzWmsabcEGJBL57fvMFTe01tHidrvBGWihYmAE6o16ORBA==');\n\nconst renameFile = function(tmp_path ,target_path){\n    return new Promise((r ,f) => {\n        // // 移动文件\n        fs.rename(tmp_path, target_path, function(err) {\n            if (err) throw err;\n            // 删除临时文件夹文件, \n            fs.unlink(tmp_path, function() {\n                if (err) throw err;  \n                r();\n            });\n        });\n    })\n},\n\nremoveFile = function(path){\n    return new Promise((r ,f) => {\n        fs.unlink(path, function(err) {\n            if (err) throw err;  \n            r();\n        });\n    })\n},\n\nuploadImage = function(name ,country){\n    let file_path = think.RUNTIME_PATH + '/upload/' + name;\n    return new Promise((r ,f) => {\n        blobService.createBlockBlobFromLocalFile(container, 'iftar/'+name, file_path , function(error, result, response) {\n            if (error || !response.isSuccessful) {r({error}); return; }\n            console.log('result:' ,result ,error);\n            r({error ,url:cdnHost[country] + 'iftar/'+name});\n        });\n        // fileService.createDirectoryIfNotExists('taskshare', 'taskdirectory', function(error, result, response) {\n        //   if (!error) {\n        //     // if result = true, share was created.\n        //     // if result = false, share already existed.\n        //   }\n        // });\n    })\n\n}\n\n\n\nexport default class extends Base {\n\n\n    // 将图片上传到MagicAD的服务器\n    async uploadimageAction(){\n        return this.fail(-1 ,'not allow'); \n        if(this.http.method!='POST'){\n            return this.fail(-1);\n        }\n\n        let param = this.post();\n        let files = this.http._file;\n\n        let len = 0;\n        for(let k in files){len++; }\n        if(len <= 0) return this.fail(-4,'张数不对！');\n\n        // return this.success(think.RESOURCE_PATH);\n\n        let target_path = think.RESOURCE_PATH + '/static/upd/';\n        var names = [];\n        for(let k in files){\n            const file = files[k];\n            const oldName = file.originalFilename;\n            const ext  = oldName.substring(oldName.lastIndexOf('.'));\n            const newName = new Date().getTime()+\"\"+parseInt(Math.random()*1000);\n            names.push(newName+ext);\n            await renameFile(file.path ,target_path+newName+ext);\n        }\n        return this.success(names);\n    }\n\n    // 将图片上传到AZURE服务器\n    async uploadAction(){\n        return this.fail(-1 ,'not allow'); \n        // 参考 https://github.com/Azure/azure-storage-node\n        if(this.http.method!='POST'){\n            return this.fail(-1);\n        }\n\n        let param = this.post();\n        let file = this.http._file.file;\n\n        let tmp_path = file.path,\n            oldName = new Date().getTime()+\"\"+parseInt(Math.random()*1000),\n            ext  = '.jpg';\n\n\n        // return this.success('123123');\n        let name = oldName+ext;\n\n        let target_path = think.RUNTIME_PATH + '/upload/' + name;\n\n        await renameFile(tmp_path ,target_path);\n        return this.success({\n            \n        });\n    }\n\n    // 将图片上传到AZURE服务器\n    async uploadazureAction(){\n        return this.fail(-1 ,'not allow'); \n        // 参考 https://github.com/Azure/azure-storage-node\n        if(this.http.method!='POST'){\n            return this.fail(-1);\n        }\n\n        let param = this.post();\n        let file = this.http._file.file;\n\n        let tmp_path = file.path,\n            oldName = new Date().getTime()+\"\"+parseInt(Math.random()*1000),\n            ext  = '.jpg';\n\n\n        // return this.success('123123');\n        let name = oldName+ext;\n\n        let target_path = think.RUNTIME_PATH + '/upload/' + name;\n\n        await renameFile(tmp_path ,target_path);\n\n        const {error ,url} = await uploadImage(name ,'id');\n        if(error){\n            return this.fail(-1 ,'上传错误！'+JSON.stringify(error));\n        }\n        await removeFile(target_path);\n        return this.success(url);\n    }\n\n    async setlikeAction(){\n        return this.fail(-1 ,'not allow'); \n\n        let param = this.post();\n        let _from    = param.from,\n            _to   = param.to ,\n            _type   = param.type ;\n\n        if(!_from || !_to || !_type){return this.fail(-1 ,'参数不正确'); }\n        let model = this.model('iftar_like' ,db);\n        let paramObj = {user_id:_from ,iftar_id:_to };\n        let count = await model.where(paramObj).count();\n        if(_type == '1'){   // 添加\n            console.log('count:' ,count);\n            if(count == 0){\n                let model_iftar = this.model('iftar' ,db);\n                await model.add(paramObj);\n                await model_iftar.execute('update iftar set `like`=`like`+1 where id='+_to);\n            }\n            return this.success('提交成功！');\n        }else{  // 删除\n            if(count > 0){\n                let model_iftar = this.model('iftar' ,db);\n                await model.delete({where: paramObj });\n                await model_iftar.execute('update iftar set `like`=`like`-1 where id='+_to);\n            }\n            return this.success('取消成功！');\n        }\n    }\n\n    async getlistAction(){\n        return this.fail(-1 ,'not allow'); \n        let param = this.get() ,\n            userid = param.id;\n\n        let res = null;\n        let model = this.model('iftar' ,db);\n        if(userid){\n            res = await model.field('base.id ,base.user_id ,base.like ,base.name,base.pic ,lk.id as islike')\n                .alias('base')\n                .join(\"iftar_like lk on lk.iftar_id=base.id and lk.user_id='\"+userid+\"'\")\n                .limit(0,100)\n                .order('`like` desc')\n                .select();\n            res.map((k) => {\n                if(k.islike){\n                    k.islike = 1;\n                }else{\n                    k.islike = '';\n                }\n            })\n            // console.log(res);\n        }else{\n            res = await model.field('id ,user_id, name, pic ,like , 0 as islike ').limit(0,100).order('`like` desc').select();\n        }\n        return this.success(res);\n    }\n\n    // 根据用户ID，获取相关内容\n    async getbyidAction(){\n        return this.fail(-1 ,'not allow'); \n        let param = this.get() ,\n            userid = param.id;\n\n        if(!userid ){return this.fail(-1 ,'参数不正确'); }\n\n        let model = this.model('iftar' ,db);\n        let res = await model.field('user_id, name, pic ,like ,id ').where(\"user_id='\"+userid+\"' \").order('id desc').select();\n        if(res.length <= 0) {\n\n            return this.fail(-2 ,'不存在！');\n        }\n        return this.success(res[0]);\n    }\n}   "]}