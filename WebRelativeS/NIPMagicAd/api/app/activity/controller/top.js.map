{"version":3,"sources":["../../../src/activity/controller/top.js"],"names":["db","activity","cache","maxAge","getRandom","min","max","parseInt","Math","random","getFixed","v","fixNum","Number","toFixed","listAction","get","page","localData","length","success","model","field","order","select","comments","set","addAction","post","comment","name","ip","avatar_img","add","avatar","content","new_id","reset","fail"],"mappings":"AAAA;;;;;;;;;;;;;;;;;;;;;;;;AACA;;;;AACA;;;;AACA;;;;AAGA;;;;;;AADA,IAAMA,KAAK,aAAGC,QAAd;;AAEA,IAAMC,QAAQ,wBAAI,EAACC,QAAQ,OAAO,EAAP,GAAY,CAArB,EAAJ,CAAd;;AAGA;AACA,IAAMC,YAAY,SAAZA,SAAY,CAASC,GAAT,EAAcC,GAAd,EAAkB;AAChC,WAAOC,SAASC,KAAKC,MAAL,MAAeH,MAAID,GAAJ,GAAQ,CAAvB,IAA0BA,GAAnC,EAAuC,EAAvC,CAAP;AACH,CAFD;;AAIA,IAAMK,WAAW,SAAXA,QAAW,CAAUC,CAAV,EAAY;AACzB,QAAIC,SAAS,IAAIC,MAAJ,CAAWF,IAAE,CAAb,EAAgBG,OAAhB,CAAwB,CAAxB,CAAb,CADyB,CACe;AACxC,WAAO,IAAID,MAAJ,CAAWD,SAAS,CAApB,EAAuBE,OAAvB,CAA+B,CAA/B,CAAP;AACH,CAHD;;;;;;;;;;AAOI;qBACMC,U;;;;;;;;AACF;mCACmB,KAAKC,GAAL,E;6CAAXC,I;AAAAA,gC,6BAAK,C;AACPC,qC,GAAYhB,MAAMc,GAAN,CAAU,uBAAqBC,IAA/B,C;;kCACfC,aAAaA,UAAUC,MAAV,GAAmB,C;;;;;6DAAU,KAAKC,OAAL,CAAaF,SAAb,C;;;AAEzCG,iC,GAAQ,KAAKA,KAAL,CAAW,cAAX,EAA2BrB,EAA3B,C;;mCACSqB,MAAMC,KAAN,CAAY,wBAAZ,EAAsCL,IAAtC,CAA2CA,IAA3C,EAAiD,EAAjD,EAAqDM,KAArD,CAA2D,SAA3D,EAAsEC,MAAtE,E;;;AAAjBC,oC;;AACJvB,kCAAMwB,GAAN,CAAU,sBAAoBT,IAA9B,EAAoCQ,QAApC;6DACO,KAAKL,OAAL,CAAaK,QAAb,C;;;;;;;;;;;;;;;;;qBAGLE,S;;;;;;;;AACF;oCAC4B,KAAKC,IAAL,E;AAAtBC,mC,SAAAA,O;+CAASC,I;AAAAA,gC,8BAAK,G;AACdC,8B,GAAK,KAAKA,EAAL,E;AACPV,iC,GAAQ,KAAKA,KAAL,CAAW,cAAX,EAA2BrB,EAA3B,C;AACRgC,sC,GAAa5B,UAAU,CAAV,EAAY,EAAZ,IAAgB,M;;mCACdiB,MAAMY,GAAN,CAAU;AACzBH,sCAAOA,IADkB,EACZ;AACbI,wCAASF,UAFgB;AAGzBG,yCAAUN,OAHe;AAIzBE,oCAAKA;AAJoB,6BAAV,C;;;AAAfK,kC;;kCAMDA,SAAS,C;;;;;AACRlC,kCAAMmC,KAAN;8DACO,KAAKjB,OAAL,CAAaY,UAAb,C;;;8DAEA,KAAKM,IAAL,CAAU,CAAC,CAAX,EAAa,OAAb,C","file":"top.js","sourcesContent":["'use strict';\nimport moment from 'moment';\nimport Base from './base.js';\nimport DB from '../../db.js';\n\nconst db = DB.activity;\nimport LRU from 'lru-cache';\nconst cache = LRU({maxAge: 1000 * 60 * 5 });\n\n\n// http://img.cdn.baca.co.id/event/top10/avatar/1.png\nconst getRandom = function(min ,max){\n    return parseInt(Math.random()*(max-min+1)+min,10);\n}\n\nconst getFixed = function (v){\n    let fixNum = new Number(v+1).toFixed(2);//四舍五入之前加1  \n    return new Number(fixNum - 1).toFixed(2);\n}\n\nexport default class extends Base {\n\n    // 获取所有的评论列表\n    async listAction(){\n        // if(!this.allow) return this.fail(-1 ,'not allow'); \n        const { page=1 } = this.get();\n        const localData = cache.get('top-comments-page-'+page);\n        if(localData && localData.length > 0) return this.success(localData);\n\n        let model = this.model('top_comments' ,db);\n        let comments = await model.field('avatar,content,addtime').page(page, 10).order('id desc').select();\n        cache.set('top-comments-page'+page ,comments);\n        return this.success(comments);\n    }\n\n    async addAction(){\n        // if(!this.allow || this.method!='post') return this.fail(-1 ,'not allow');\n        let { comment ,name='-' } = this.post();\n        const ip = this.ip();\n        let model = this.model('top_comments' ,db);\n        let avatar_img = getRandom(1,16)+'.png';\n        let new_id = await model.add({\n            name : name, // 发起用户姓名\n            avatar : avatar_img ,\n            content : comment ,\n            ip : ip\n        });\n        if(new_id > 0) {\n            cache.reset();\n            return this.success(avatar_img);\n        }else{\n            return this.fail(-2,'添加失败！');\n        }\n    }\n}   "]}