{"version":3,"sources":["../../../src/activity/controller/gc.js"],"names":["db","activity","cache","maxAge","getRandom","min","max","parseInt","Math","random","getFixed","v","fixNum","Number","toFixed","verifyToken","token","res","userid","utc","date_time","Date","e","userAction","allow","method","fail","post","t","user_id","localData","get","success","alluserAction","model","field","select","list","json","adduserAction","name","phone","city","sex","add","new_id","set"],"mappings":"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","file":"gc.js","sourcesContent":["'use strict';\nimport moment from 'moment';\nimport Base from './base.js';\nimport DB from '../../db.js';\nimport {decryptCode ,simpleDecryptCode} from '../../util.js';\n\nconst db = DB.activity;\nimport LRU from 'lru-cache';\nconst cache = LRU({maxAge: 1000 * 60 * 30 });\n\n\n// http://img.cdn.baca.co.id/event/top10/avatar/1.png\nconst getRandom = function(min ,max){\n    return parseInt(Math.random()*(max-min+1)+min,10);\n}\n\nconst getFixed = function (v){\n    let fixNum = new Number(v+1).toFixed(2);//四舍五入之前加1  \n    return new Number(fixNum - 1).toFixed(2);\n}\n\nconst verifyToken = function (token) {\n    try{\n        const res = decryptCode(token ,'ymark-campaign');\n        if(!res || !res.userid || !res.utc || res.userid == 'wap_') return false;\n        const date_time = new Date(res.utc);\n        // if(typeof(date_time) != 'object') return false;\n        // const current_utc_str = (new Date()).toUTCString();\n        // const current_utc_time = (new Date( current_utc_str  )).getTime();\n        // 差值必须小于20分钟以内\n        // if(parseInt(Math.abs(date_time.getTime() - current_utc_time)/(1000*60)) >= 20){\n            // return false;\n        // }\n        return res.userid;\n    }catch(e){\n        return false;\n    }\n}\n\nexport default class extends Base {\n\n    async userAction(){\n        if(!this.allow || this.method!='post') return this.fail(-1 ,'not allow');\n        const {t} = this.post();\n        if(!t) return this.fail(-1, '参数错误！');\n        const user_id = verifyToken(t);\n        if(!user_id) return this.fail(-1.2, '参数错误！');\n        const localData = cache.get('user_id_object');\n        if(localData && localData[user_id]) return this.success(localData[user_id]);\n        // 数据库\n        return this.fail(-2, 'null');\n    }\n\n\n    async alluserAction(){\n        let model = this.model('gc_user_temp' ,db);\n        const list = await model.field('name,sex,phone,city').select();\n        return this.json(list);\n    }\n\n\n    async adduserAction(){\n        if(!this.allow || this.method!='post') return this.fail(-1 ,'not allow');\n        let { name, phone ,city ,userid ,sex } = this.post();\n        if( !name || !phone || !city || !sex || !userid ) return this.fail(-1.21, '参数错误！');\n        let model = this.model('gc_user_temp' ,db);\n        let new_id = await model.add({\n            name : name ,\n            phone : phone ,\n            city : city ,\n            sex : sex ,\n            user_id : userid,\n        });\n        if(new_id > 0) {\n            let localData = cache.get('user_id_object') || {};\n            localData[userid] = {name:name ,phone:phone ,city:city};\n            cache.set('user_id_object' ,localData);\n            return this.success('添加成功！');\n        }else{\n            return this.fail(-2,'添加失败！');\n        }\n    }\n\n\n}"]}