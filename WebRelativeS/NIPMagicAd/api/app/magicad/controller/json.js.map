{"version":3,"sources":["../../../src/magicad/controller/json.js"],"names":["cache","maxAge","blobService","createBlobService","basePath","think","RUNTIME_PATH","renameFile","tmp_path","target_path","r","f","rename","err","unlink","writeFile","name","jsonData","file_path","e","getFile","cname","stream","createWriteStream","getBlobToStream","error","result","response","message","data","readFileSync","JSON","parse","getList","path","listBlobsSegmented","res","entries","map","indexOf","push","uploadFile","createBlockBlobFromLocalFile","contentSettings","contentType","cacheControl","getAction","get","fail","local","success","list","set","getjsonAction","content","createjsonAction","post","appname","configname","expireinseconds","AdUnitDetails","AppName","ConfigName","ExpireInSeconds","del","testAction","submitcontentAction","k","trueData","editble","i","clone","_type","Type"],"mappings":"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","file":"json.js","sourcesContent":["'use strict';\nimport azure from 'azure-storage';\nimport moment from 'moment';\nimport Base from './base.js';\nimport fs from 'fs';\n\nimport LRU from 'lru-cache';\nconst cache = LRU({ maxAge: 1000 * 60 * 60 });\n\nconst blobService = azure.createBlobService('nipcleantool', '7kAN5quppIjeVs5KvAtC1UXcP1UBwgWJzIvWXNtosa4ZYf7Z20jmVncM8VaQtGGJPjfCivzvnIBN41BZfYjYQg==');\n\nconst basePath = think.RUNTIME_PATH + '/json/';\nconst renameFile = function(tmp_path ,target_path){\n    return new Promise((r ,f) => {\n        // // 移动文件\n        fs.rename(tmp_path, target_path, function(err) {\n            if (err) throw err;\n            // 删除临时文件夹文件, \n            fs.unlink(tmp_path, function() {\n                if (err) throw err;  \n                r();\n            });\n        });\n    })\n},\n\nwriteFile = function (name, jsonData) {\n    let file_path = basePath+name ;\n    return new Promise((r ,f) => {\n        fs.writeFile(file_path,JSON.stringify(jsonData),function(e){\n            r();\n        })\n    });\n},\n\ngetFile = function(name ,cname){\n    let file_path = basePath+name ;\n    let stream = fs.createWriteStream(file_path);\n    return new Promise((r ,f) => {\n        blobService.getBlobToStream(cname, name, stream, function(error, result, response) {\n            if (error!=null && typeof(error) != 'undefined' ) return r({err:JSON.stringify(error.message)}); \n            const data = fs.readFileSync(file_path,\"utf-8\"); ;\n            return r(JSON.parse(data));\n        });\n    })\n\n},\n\ngetList = function(cname){\n    return new Promise((r ,f) => {\n        const path = 'https://nipcleantool.blob.core.windows.net/resources/';\n        blobService.listBlobsSegmented(cname, null, function(error, result, response) {\n            if (error!=null && typeof(error) != 'undefined' ) return r({err:JSON.stringify(error.message)}); \n            const res = [];\n            result.entries.map(({name}) => {\n                if(name.indexOf('.json') >= 0) res.push({name:name});\n            })\n            return r(res);\n        });\n    })\n\n},\n\n\nuploadFile = function(name ,cname){\n    return new Promise((r ,f) => {\n        blobService.createBlockBlobFromLocalFile(cname, name, basePath+name ,{\n            contentSettings : {\n                contentType : 'application/json',\n                cacheControl : 'public, max-age=300'\n            }\n        }, function(error, result, response) {\n            if (error!=null && typeof(error) != 'undefined' ) return r({err:JSON.stringify(error.message)}); \n            r();\n        });\n    })\n\n}\n\n\nexport default class extends Base {\n    // 返回处理后的列表\n    async getAction(){\n        const {cname} = this.get();\n        if(!cname) return this.fail(-1,'参数错误！');\n        const local = cache.get('json-list-'+cname);\n        if(local) return this.success(local);\n        const list = await getList(cname);\n        cache.set('json-list-'+cname ,list);\n        return this.success(list);\n    }\n\n\n\n    async getjsonAction(){\n        const {name ,cname} = this.get();\n        if(!name || !cname) return this.fail(-1);\n        const local = cache.get('json-'+cname+'-'+name);\n        if(local) return this.success(local);\n        const content = await getFile(name ,cname);\n        if(content.err) return this.fail(content.err);\n        cache.set('json-'+cname+'-'+name ,content);\n        return this.success(content);\n    }\n\n    async createjsonAction(){\n        const {name ,appname ,configname ,expireinseconds ,cname} = this.post();\n        if(!cname || !name || !appname || !configname || !expireinseconds) return this.fail(-1);\n        await writeFile(name ,{\n            AdUnitDetails : {},\n            AppName : appname ,\n            ConfigName : configname,\n            ExpireInSeconds : expireinseconds\n        })\n        await uploadFile(name ,cname);\n        cache.del('json-list-'+cname);\n        return this.success('提交成功！');\n    }\n\n    async testAction(){\n        await uploadFile('adconfig_goclean.json' ,'test');\n        return this.success('提交成功！');\n    }\n\n    async submitcontentAction(){\n        const {k,name ,cname} = this.post();\n        if(!k || !name || !cname) return this.fail(-1);\n        let jsonData = null;\n        let AdUnitDetails = null;\n        try{\n            jsonData = JSON.parse(k);\n            AdUnitDetails = jsonData.AdUnitDetails;\n        }catch(e){\n            return this.fail(-2);\n        }\n        const trueData = {};\n        AdUnitDetails.map((k) => {\n            delete k.editble;\n            delete k.i;\n            delete k.clone;\n            const _type = k.Type;\n            delete k.Type;\n            if(!trueData[_type]) trueData[_type] = [];\n            trueData[_type].push(k);\n        });\n        jsonData['AdUnitDetails'] = trueData;\n        // 第一步，将JSON内容写入文件中\n        await writeFile(name ,jsonData)\n        // 第二步，提交到Storage中\n        const res = await uploadFile(name ,cname);\n        // 清空服务器缓存\n        cache.del('json-'+cname+'-'+name);\n        return this.success(res); \n    }\n\n}   "]}