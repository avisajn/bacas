{"version":3,"sources":["../../../src/magicad/controller/offer.js"],"names":["container","cdnHost","id","br","db","dbmagicad","blobService","createBlobService","renameFile","tmp_path","target_path","r","f","rename","err","unlink","uploadImage","name","country","file_path","think","RUNTIME_PATH","createBlockBlobFromLocalFile","error","result","response","isSuccessful","url","uploadFile","path","getadunitAction","model","field","where","app","select","data","success","uploadtestAction","names","urls","i","len","length","console","log","push","getadunitsAction","getpublisherAction","savepublisherAction","param","post","fail","add","publisher_name","deleteAction","model_offer","update","enable","insertId","saveofferAction","start_time","end_time","adunit_id","adunit","publisher_id","publisher","cpm","ses_filter","age_filter","gender_filter","city_filter","width","height","cta","cta_text","impression_cap","click_cap","target_url","click_callback_url","impression_callback_url","title","description","creative_url","dateNow","Date","format","model_creative","offer_param","updated_time","location_filter","offer_id","creative_id","getAction","get","current","u","column","alias","join","order","page","list","map","k","start_time_str","end_time_str","updimgAction","uploadimageAction","http","method","start","end","file","_file","oldName","originalFilename","ext","substring","lastIndexOf"],"mappings":"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","file":"offer.js","sourcesContent":["'use strict';\nimport azure from 'azure-storage';\nimport moment from 'moment';\nimport Base from './base.js';\nimport DB from '../../db.js';\nimport fs from 'fs';\n\n\nconst container = 'news-images';\nconst cdnHost = {\n    id : 'http://img.cdn.baca.co.id/',\n    br : 'http://img.cdn.baca.co.id/'\n}\n\n\nconst db = DB.dbmagicad;\n\nconst blobService = azure.createBlobService('baca', 'AlfJeE0T/a0hWMXRTR0oYj7GVxhvNAkL+brSotrJqzWmsabcEGJBL57fvMFTe01tHidrvBGWihYmAE6o16ORBA==');\n\nconst renameFile = function(tmp_path ,target_path){\n    return new Promise((r ,f) => {\n        // // 移动文件\n        fs.rename(tmp_path, target_path, function(err) {\n            if (err) throw err;\n            // 删除临时文件夹文件, \n            fs.unlink(tmp_path, function() {\n                if (err) throw err;  \n                r();\n            });\n        });\n    })\n},\n\nuploadImage = function(name ,country){\n    let file_path = think.RUNTIME_PATH + '/upload/' + name;\n    return new Promise((r ,f) => {\n        blobService.createBlockBlobFromLocalFile(container, 'ads/'+name, file_path , function(error, result, response) {\n            if (error || !response.isSuccessful) {r({error}); return; }\n            r({error ,url:cdnHost[country] + 'ads/'+name});\n        });\n    })\n},\nuploadFile = function(name ,path ,country){\n    return new Promise((r ,f) => {\n        blobService.createBlockBlobFromLocalFile(container, 'event/top10/'+name, path+name , function(error, result, response) {\n            if (error || !response.isSuccessful) {r({error}); return; }\n            r({error ,url:cdnHost[country] + 'event/top10/'+name});\n        });\n    })\n};\n\n\n\nexport default class extends Base {\n    // 返回处理后的列表\n    async getadunitAction(){\n        const model = this.model('adunit' ,db);\n        const data = await model.field('id,name,creative_ratio,creative_size_limitation').where({app:'baca'}).select();\n        // data.map((k) => {\n        //     k.name = k.name+'_'+(parseInt(k.index)+1);\n        //     delete k.index;\n        // })\n        return this.success(data);\n    }\n\n    async uploadtestAction(){\n        const path = '/Users/wangxiaowei/Desktop/tinified/';\n        const names = [\n            'abg-nikah.jpg',\n            'ahok-rizieq.jpg',\n            'darah.jpg',\n            'dp-rumah.jpg',\n            'julia.jpg',\n            'pilkada.jpg',\n            'raffi-ayu.jpg',\n            'salman.jpg',\n            'uang.jpg',\n            'zakir.jpg',\n        ];\n        const urls = [];\n        for(let i=0,len=names.length;i<len;i++){\n            const {error ,url} = await uploadFile(names[i], path ,'id');\n            if(error){\n                console.log('error:' ,names[i]);\n            }else{\n                urls.push(url);\n                console.log('url:',url)\n            }\n        }\n        return this.success(urls);\n    }\n    \n    async getadunitsAction(){\n        const model = this.model('adunit' ,db);\n        const data = await model.field(\"id,CONCAT(app,'_',name) as name,creative_ratio,creative_size_limitation\").select();\n        return this.success(data);\n    }\n\n    // 返回所有的发布人\n    async getpublisherAction(){\n        const model = this.model('publisher' ,db);\n        const data = await model.field('id,publisher_name name').select();\n        return this.success(data);\n    }\n\n    // 返回所有的发布人\n    async savepublisherAction(){\n        let param = this.post();\n        let name = param.name;\n        if(!name){\n            return this.fail(-1 ,'参数不正确');\n        }\n        let model = this.model('publisher' ,db);\n        const id = await model.add({publisher_name : name})\n        if(id){\n            return this.success(id);\n        }else{\n            return this.fail(-1 ,id);\n        }\n    }\n\n    async deleteAction(){\n        let {id} = this.post();\n        if (!id) return this.fail('id为空！');\n        let model_offer = this.model('offer' ,db);\n        let insertId = await model_offer.where(\"id=\"+id).update({enable : 0});\n        return this.success('删除成功！');\n    }\n\n\n    async saveofferAction(){\n        let param = this.post();\n        let name = param.name,                      // offer 表\n            start_time  = param.start_time,         // offer 表\n            end_time    = param.end_time,           // offer 表\n            adunit_id   = param.adunit,           // offer 表\n            publisher_id    = param.publisher,           // offer 表\n\n            cpm    = param.cpm,           // offer 表\n            ses_filter    = param.ses_filter || '',           // offer 表\n            age_filter    = param.age_filter || '',           // offer 表\n            gender_filter    = param.gender_filter || '',           // offer 表\n            city_filter    = param.city_filter || '',           // offer 表\n\n            width       = param.width,              // creative 表\n            height      = param.height,\n            cta         = param.cta_text,\n\n            impression_cap      = param.impression_cap,\n            click_cap      = param.click_cap,\n\n            target_url  = param.target_url,\n            click_callback_url  = param.click_callback_url,\n            impression_callback_url     = param.impression_callback_url,\n            title       = param.title,\n            description     = param.description,\n            creative_url    = param.creative_url,\n\n            country     = 'id', // 默认的国家为印尼\n\n            dateNow = moment(new Date()).format('YYYY-MM-DD HH:mm:ss');\n\n        if(!name){\n            return this.fail(-1 ,'参数不正确');\n        }\n\n        let model_offer = this.model('offer' ,db);\n        let model_creative = this.model('creative' ,db);\n\n        const offer_param = {\n            updated_time : dateNow,\n            start_time : start_time,\n            end_time : end_time,\n            publisher_id : publisher_id,\n            adunit_id : adunit_id,\n            name : name,\n            cpm : cpm,\n            ses_filter : ses_filter,\n            age_filter : age_filter,\n            gender_filter : gender_filter,\n            location_filter : city_filter,\n        };\n\n        if(impression_cap) offer_param['impression_cap'] = impression_cap;\n        if(click_cap) offer_param['click_cap'] = click_cap;\n\n        const offer_id = await model_offer.add(offer_param);\n\n        if(!offer_id){\n            return this.fail(-1 ,'插入offer出错！');\n        }\n\n        const creative_id = await model_creative.add({\n            offer_id : offer_id,\n            width : width,\n            height : height,\n            cta : cta,\n            creative_url : creative_url,\n            target_url : target_url,\n            click_callback_url : click_callback_url,\n            impression_callback_url :impression_callback_url ,\n            title : title,\n            description : description,\n        });\n        if(!creative_id){\n            return this.fail(-1 ,'插入creative出错！');\n        }\n        return this.success({offer_id ,creative_id});\n    }\n\n    async getAction(){\n        let {current=1 ,u}      = this.get();\n        let where = ' base.enable = 1 ';\n        if(!u){\n            where += \" and u.app='baca' \";\n        }\n        const model_offer = this.model('offer' ,db);\n        const column = [\n            'base.id as offer_id',\n            'base.start_time as start_time',\n            'base.end_time as end_time',\n            'base.publisher_id as publisher_id',\n            'base.impression_cap as impression_cap',\n            'base.click_cap as click_cap',\n            'base.adunit_id as adunit_id',\n            'base.name as name',\n            'base.cpm as cpm',\n            'base.ses_filter as ses_filter',\n            'base.age_filter as age_filter',\n            'base.gender_filter as gender_filter',\n            'base.location_filter as city_filter',\n            'c.width as width',\n            'c.height as height',\n            'c.cta as cta',\n            'c.creative_url as creative_url',\n            'c.target_url as target_url',\n            'c.click_callback_url as click_callback_url',\n            'c.impression_callback_url as impression_callback_url',\n            'c.title as title',\n            'c.description as description'\n        ]\n        const list = await model_offer.alias('base').field(column)\n                .join('creative c on c.offer_id = base.id')\n                .join('adunit u on u.id = base.adunit_id')\n                .where(where)\n                .order('base.id desc').page(current,20).select();\n        list.map((k) => {\n            k.start_time_str = moment(k.start_time).add(7,'hour').format('YYYY-MM-DD HH:mm:ss');\n            k.end_time_str = moment(k.end_time).add(7,'hour').format('YYYY-MM-DD HH:mm:ss');\n            k.start_time = moment(k.start_time).add(7,'hour').format('YYYY-MM-DD');        \n            k.end_time = moment(k.end_time).add(7,'hour').format('YYYY-MM-DD');  \n        })\n        return this.success(list);\n    }\n\n    async updimgAction(){\n        const { offer_id ,creative_url ,width ,height } = this.post();\n        if(!offer_id || !creative_url) return this.fail(-1,'参数错误！');\n\n        let model = this.model('creative' ,db);\n        let insertId = await model.where(\"offer_id=\"+offer_id).update({\n            creative_url : creative_url, \n            width : width,\n            height : height,\n        });\n        return this.success('修改成功！');\n    }\n\n\n    async uploadimageAction(){\n        // 参考 https://github.com/Azure/azure-storage-node\n        if(this.http.method!='POST'){\n            return this.fail(-1);\n        }\n\n        let param = this.post(),\n            start = param.start ,\n            end = param.end,\n            title = param.title;\n\n        let file = this.http._file[0];\n\n        if(!file || !start || !end || !title){\n            return this.fail(-1 ,'参数错误！');\n        }\n\n        let tmp_path = file.path,\n            oldName = file.originalFilename,\n            ext  = oldName.substring(oldName.lastIndexOf('.'));\n\n        let name = title+\"_\"+start+\"_\"+end+ext;\n\n        let target_path = think.RUNTIME_PATH + '/upload/' + name;\n\n        await renameFile(tmp_path ,target_path);\n\n\n        const {error ,url} = await uploadImage(name ,'id');\n        if(error){\n            return this.fail(-1 ,'上传错误！'+JSON.stringify(error));\n        }\n        return this.success(url);\n    }\n\n\n\n}   "]}